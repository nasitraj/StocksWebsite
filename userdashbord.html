<!DOCTYPE html>
<html lang="en">
<head>
<title>User Dashbord</title>
<meta name="author" content="Raj Nasit">
<meta name="description" content="About me page">
<link rel="stylesheet" type="text/css" href="style.css"/>
<script>
    const socket = new WebSocket('wss://ws.finnhub.io?token=cnkd071r01qiclq83k4gcnkd071r01qiclq83k50');
    var lastStock = "";
    socket.addEventListener('message', function (event) {
        console.log('Message from server ', event.data);
            var stock = document.getElementById("stockdetails");
           // stock.innerText = JSON.stringify(JSON.parse(event.data)["data"]);
           var list = (JSON.parse(event.data)["data"]);
           console.log(list);
           list.forEach(element=>{
            let stockid = element["s"];
            let stockprice = element["p"];
            stock.innerHTML = "";
            stock.innerHTML += "<h2>" + stockid +"</h2>"
            stock.innerHTML += "<h2>$" + stockprice + "</h2>"
           
           });
           
            // div.innerHTML += "<h2  style=\"color: green;\">" + element["change_percentage"] +"</h2>"
            // document.getElementById("topstockcotainers").appendChild(div);
            // console.log(element);
        });
    function getCompanyDetails(){
        console.log("in getcompanydetails function");
       
        if(lastStock != ""){
            socket.send(JSON.stringify({'type':'unsubscribe','symbol': lastStock}))
        }

        var company = document.getElementById("company").value;
        console.log(company);
        if(company == ""){
            return;
        }
        lastStock = company;
        var stock = document.getElementById("stockdetails");
        stock.innerHTML = "";
        socket.send(JSON.stringify({'type':'subscribe', 'symbol': company}));


        // Listen for messages
        // socket.addEventListener('message', function (event) {
        //     console.log('Message from server ', event.data);
        //     // var stock = document.getElementById("stockdetails");
        //     // let div = document.getElementById()
        //     // let div = document.createElement("div");
        //     // div.className = "stockblocks"
        //     // div.innerHTML += "<h2>" + element["ticker"] +"</h2>"
        //     // div.innerHTML += "<h2>$" + element["price"] +"(+<span style=\"color: green;\">" +element["change_amount"]+ "</span>)</h2>"
        //     // div.innerHTML += "<h2  style=\"color: green;\">" + element["change_percentage"] +"</h2>"
        //     // document.getElementById("topstockcotainers").appendChild(div);
        //     // console.log(element);
        // });

        
        
        fetch("https://finnhub.io/api/v1/stock/profile2?symbol=" + company + "&token=cnkd071r01qiclq83k4gcnkd071r01qiclq83k50")
            .then(response => {
                if (!response.ok) {
                throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                var profileDiv = document.getElementById('companiesprofile');
                profileDiv.innerHTML = "";
                profileDiv.innerHTML += "<img src=\"" + data["logo"]+"\"><br>";
                profileDiv.innerHTML += data["name"]+ "<br>";
                profileDiv.innerHTML += "Contry: "  +data["country"]+ "(" + data["currency"] +")<br>";
                profileDiv.innerHTML += "Field: "  +data["finnhubIndustry"] + " IPO: " + data["ipo"] +" <br>";
                profileDiv.innerHTML += "Market Capitalization: "  +data["marketCapitalization"] + "<br>";
                profileDiv.innerHTML += "Share Outstanding: "  +data["shareOutstanding"] + "<br>";
                

            })
            .catch(error => { console.error('Error:', error);
            });


             
       

            fetch("https://finnhub.io/api/v1/company-news?symbol=" + company + "&from=2023-07-03&to=2024-04-03&token=cnkd071r01qiclq83k4gcnkd071r01qiclq83k50")
            .then(response => {
                if (!response.ok) {
                throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                data.forEach(element => {
                let div = document.createElement("div");
                    div.className = "newsblocks"
                    div.innerHTML += "<h2>" + element["headline"] +"</h2>"
                    if( element["image"] != ""){
                    div.innerHTML += "<img src='" + element["image"] + "' style=\"max-width: 400px;\">";
                    }
                    div.innerHTML += "<br>" + element["summary"] +"<br>"
                    document.getElementById("companyNews").appendChild(div);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
</script>
</head>
<body>
    <h1>Page Title</h1>
<div>
    <form onsubmit="event.preventDefault(); getCompanyDetails();">
        <input placeholder="Search.." list="companies" id="company">
        <datalist id="companies"></datalist>

        <script>
            fetch("https://finnhub.io/api/v1/stock/symbol?exchange=US&token=cnkd071r01qiclq83k4gcnkd071r01qiclq83k50")
            .then(response => {
                if (!response.ok) {
                throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                var list = document.getElementById('companies');
                data.forEach(element => {
                    //console.log(element);
                    var option = document.createElement('option');
                    option.text = element["description"];
                    option.value = element["symbol"];
                    list.appendChild(option);
                });
            })
            .catch(error => { console.error('Error:', error);
            });
            

        </script>
        <input type="submit">
    </form>
   
    
</div>
<div id="companieInfo">
<div id="stockdetails">
   
</div>

<div id="companiesprofile">

</div>
</div>
<div id="companyNews"></div>

</body>
</html>
